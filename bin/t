#!/usr/bin/env bash

# Let zoxide determine the working directory for the session
if [ -z "$1" ]; then
    ZOXIDE_RESULT=$PWD
else
    ZOXIDE_RESULT=$(zoxide query "$1")
fi

# name of working directory for session
FOLDER=$(basename "$ZOXIDE_RESULT")

# lookup tmux session name
SESSION=$(tmux list-sessions | grep "$FOLDER" | awk '{print $1}')
SESSION=${SESSION//:/}

# check if variable is empty 
# if not currently in tmux
if [ -z "$TMUX" ]; then
  # tmux is not active
  echo "is not tmux"
  if [ -z "$SESSION" ]; then
    # session does not exist
    echo "session $SESSION does not exist"
    # jump to directory
    cd "$ZOXIDE_RESULT" || (echo "Failed to change directory."; exit 1)
    # create session
    tmux new-session -s "$FOLDER"
  else
    # session exists
    echo "session exists"
    # attach to session
    tmux attach -t "$SESSION"
  fi
else
  # tmux is active
  echo "is tmux"
  if [ -z "$SESSION" ]; then
    # session does not exist
    echo "session $SESSION does not exist"
    # jump to directory
    cd "$ZOXIDE_RESULT" || (echo "Failed to change directory."; exit 1)
    # create session
    tmux new-session -d -s "$FOLDER"
    # attach to session
    tmux switch-client -t "$FOLDER"
  else
    # session exists
    echo "session exists"
    # switch to tmux session
    tmux switch-client -t "$SESSION"
  fi
fi
