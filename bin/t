#!/usr/bin/env bash

# determine the path for the session
if [ -z "$1" ]; then
    ZOXIDE_RESULT=$PWD
else
    ZOXIDE_RESULT=$(zoxide query "$1")
fi

if [ -z "$ZOXIDE_RESULT" ]; then
    exit 1
fi

# name of working directory for session
FOLDER=$(basename "$ZOXIDE_RESULT")

if [ -n "$WEZTERM_EXECUTABLE" ]; then
    SESSION=$(wezterm cli list | grep "$FOLDER" | awk '{print $3}' | head -1)
elif  [ -n "$TMUX" ]; then
    SESSION=$(tmux list-sessions | grep "$FOLDER" | awk '{print $1}')
    SESSION=${SESSION//:/}
else
    exit 1
fi




if [ -n "$WEZTERM_EXECUTABLE" ]; then
    cd "$ZOXIDE_RESULT" || (echo "Failed to change directory."; exit 1)
    wezterm cli acti
fi


if [ -z "$TMUX" ] && [ -z "$SESSION" ]; then
    # echo "session $SESSION does not exist"
    cd "$ZOXIDE_RESULT" || (echo "Failed to change directory."; exit 1)
    tmux new-session -s "$FOLDER"
  else
    # echo "session $SESSION exists"
    tmux attach -t "$SESSION"
  fi
fi

# echo "tmux is active"
if [ -z "$SESSION" ]; then
  # echo "session $SESSION does not exist"
  cd "$ZOXIDE_RESULT" || (echo "Failed to change directory."; exit 1)
  tmux new-session -d -s "$FOLDER"
  tmux switch-client -t "$FOLDER"
fi

tmux switch-client -t "$SESSION"
